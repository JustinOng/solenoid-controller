<html>
  <head>
    <style>
      .display-table td {
        width: 48px;
        height: 48px;
        text-align: center;
        font-size: 12;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: bold;
        -webkit-text-stroke: 0.5px black;
        -webkit-text-fill-color: white;
      }

      #transform-config-container > div {
        width: 33%;
        display: flex;
        margin-right: 8px;
      }

      #transform-config-container input[type="text"] {
        flex-grow: 1;
      }
    </style>
    <script>
      const HOST = localStorage.getItem("host") || "";

      async function render() {
        let statuses = [];

        for (let id = 0; id < 3; id++) {
          const sensor_url = HOST + `/sensor?sensor=${id}`;
          const data = await (await fetch(sensor_url)).json();

          const status = data.shift();
          const STATUS_MAP = {
            1: "Initializing",
            2: "Initialization failed",
            3: "Active",
            4: "Communication Timeout",
          };

          statuses.push(STATUS_MAP[status] || "ERROR");

          const cells = document.querySelectorAll(`#display-table${id} td`);
          for (const [i, zone] of data.entries()) {
            const [target_status, distance] = zone;
            cells[i].innerHTML = `${i}<br/>${distance}<br/>(${target_status})`;

            const MAX_DISTANCE = 3000;
            const c = (distance / MAX_DISTANCE) * 255;

            cells[i].style.backgroundColor = `rgb(${c}, ${c}, ${c})`;
          }
        }

        document.querySelector("#status").innerText = statuses.join(" / ");
      }

      window.onload = async () => {
        for (let id = 0; id < 3; id++) {
          document.querySelector(`#display-table${id} tbody`).innerHTML +=
            "<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>".repeat(
              8
            );

          const data = await get_string(`transform${id}`);
          document.querySelector(`#transform${id}`).value = data;
          document.querySelector(`#display-table${id}`).style.transform = data;
        }
      };

      function update_transform(id) {
        const val = document.querySelector(`#transform${id}`).value;
        document.querySelector(`#display-table${id}`).style.transform = val;
      }

      async function get_string(key) {
        const res = await fetch(HOST + `/config/string?key=${key}`);
        const data = await res.text();
        return data;
      }

      async function put_string(key, value) {
        return fetch(HOST + `/config/string?key=${key}`, {
          method: "POST",
          body: `value=${value}`,
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
        });
      }

      setInterval(render, 200);
    </script>
  </head>
  <body>
    Status: <span id="status"></span>
    <table id="display-table0" class="display-table">
      <tbody></tbody>
    </table>
    <table id="display-table1" class="display-table">
      <tbody></tbody>
    </table>
    <table id="display-table2" class="display-table">
      <tbody></tbody>
    </table>
    <div
      style="display: flex; flex-direction: row"
      id="transform-config-container"
    >
      <div>
        transform0:
        <input
          id="transform0"
          type="text"
          onkeyup="update_transform(0)"
        /><input
          type="button"
          value="S"
          onclick="put_string('transform0', this.previousSibling.value)"
        />
      </div>
      <div>
        transform1:
        <input
          id="transform1"
          type="text"
          onkeyup="update_transform(1)"
        /><input
          type="button"
          value="S"
          onclick="put_string('transform1', this.previousSibling.value)"
        />
      </div>
      <div>
        transform2:
        <input
          id="transform2"
          type="text"
          onkeyup="update_transform(2)"
        /><input
          type="button"
          value="S"
          onclick="put_string('transform2', this.previousSibling.value)"
        />
      </div>
    </div>
  </body>
</html>
